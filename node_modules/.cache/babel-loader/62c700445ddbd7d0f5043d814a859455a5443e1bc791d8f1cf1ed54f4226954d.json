{"ast":null,"code":"import { Transaction } from '@solana/web3.js';\nimport { Buffer } from 'buffer';\nimport { createSecp256r1Instruction } from './transactionUtils';\n\n// Định nghĩa kiểu wallet tương thích\n\n/**\n * Kiểm tra instruction secp256r1 độc lập\n * @param connection Kết nối Solana\n * @param message Message gốc cần xác thực\n * @param publicKey Public key đã nén (33 bytes)\n * @param signature Chữ ký raw (64 bytes)\n * @param wallet Wallet để ký giao dịch\n */\nexport async function testSecp256r1(connection, message, publicKey, signature, wallet) {\n  try {\n    console.log('Kiểm tra secp256r1 với:', {\n      publicKey: publicKey.toString('hex'),\n      publicKeyLength: publicKey.length,\n      signature: signature.toString('hex'),\n      signatureLength: signature.length,\n      message: message.toString(),\n      messageBytes: message.toString('hex'),\n      messageLength: message.length\n    });\n\n    // Tạo instruction secp256r1\n    const instruction = createSecp256r1Instruction(message, publicKey, signature);\n\n    // Tạo và gửi transaction\n    const transaction = new Transaction().add(instruction);\n    transaction.feePayer = wallet.publicKey;\n    const {\n      blockhash\n    } = await connection.getLatestBlockhash();\n    transaction.recentBlockhash = blockhash;\n    const signedTx = await wallet.signTransaction(transaction);\n    const txSignature = await connection.sendRawTransaction(signedTx.serialize());\n    console.log('Giao dịch đã được gửi với signature:', txSignature);\n    await connection.confirmTransaction(txSignature, 'confirmed');\n    console.log('Giao dịch đã được xác nhận');\n    return true;\n  } catch (error) {\n    console.error('Lỗi khi kiểm tra secp256r1:', error);\n    return false;\n  }\n}\n\n/**\n * Tạo các biến thể khác nhau của public key để kiểm tra\n * @param publicKey Public key gốc\n */\nexport function generatePublicKeyVariants(publicKey) {\n  const variants = [];\n\n  // Biến thể 1: Giữ nguyên public key gốc\n  variants.push(Buffer.from(publicKey));\n  console.log('Biến thể 1 (Gốc):', publicKey.toString('hex'));\n\n  // Biến thể 2: Đảo ngược tất cả các byte\n  const fullReversedPubKey = Buffer.from(publicKey);\n  fullReversedPubKey.reverse();\n  variants.push(fullReversedPubKey);\n  console.log('Biến thể 2 (Đảo ngược tất cả):', fullReversedPubKey.toString('hex'));\n\n  // Biến thể 3: Đảo ngược tất cả các byte trừ byte đầu tiên\n  const partialReversedPubKey = Buffer.alloc(33);\n  partialReversedPubKey[0] = publicKey[0]; // Giữ nguyên byte đầu tiên\n  for (let i = 1; i < 33; i++) {\n    partialReversedPubKey[i] = publicKey[34 - i]; // Đảo ngược các byte còn lại\n  }\n  variants.push(partialReversedPubKey);\n  console.log('Biến thể 3 (Đảo ngược trừ byte đầu):', partialReversedPubKey.toString('hex'));\n\n  // Biến thể 4: Chuyển đổi byte đầu tiên giữa 0x02 và 0x03 (thay đổi dấu của y)\n  const prefixChangedPubKey = Buffer.from(publicKey);\n  if (prefixChangedPubKey[0] === 0x02) {\n    prefixChangedPubKey[0] = 0x03;\n  } else if (prefixChangedPubKey[0] === 0x03) {\n    prefixChangedPubKey[0] = 0x02;\n  }\n  variants.push(prefixChangedPubKey);\n  console.log('Biến thể 4 (Đổi dấu y):', prefixChangedPubKey.toString('hex'));\n  return variants;\n}\n\n/**\n * Kiểm tra với nhiều biến thể của public key\n */\nexport async function testMultiplePublicKeys(connection, message, signature, wallet, publicKeyVariants) {\n  console.log(`Bắt đầu kiểm tra với ${publicKeyVariants.length} biến thể của public key...`);\n  for (let i = 0; i < publicKeyVariants.length; i++) {\n    const variant = publicKeyVariants[i];\n    console.log(`Kiểm tra biến thể #${i + 1}:`, variant.toString('hex'));\n    const success = await testSecp256r1(connection, message, variant, signature, wallet);\n    if (success) {\n      console.log(`Biến thể #${i + 1} thành công!`);\n    } else {\n      console.log(`Biến thể #${i + 1} thất bại.`);\n    }\n  }\n  console.log('Đã hoàn tất việc kiểm tra các biến thể.');\n}","map":{"version":3,"names":["Transaction","Buffer","createSecp256r1Instruction","testSecp256r1","connection","message","publicKey","signature","wallet","console","log","toString","publicKeyLength","length","signatureLength","messageBytes","messageLength","instruction","transaction","add","feePayer","blockhash","getLatestBlockhash","recentBlockhash","signedTx","signTransaction","txSignature","sendRawTransaction","serialize","confirmTransaction","error","generatePublicKeyVariants","variants","push","from","fullReversedPubKey","reverse","partialReversedPubKey","alloc","i","prefixChangedPubKey","testMultiplePublicKeys","publicKeyVariants","variant","success"],"sources":["/Users/tai/Documents/MoonWallet/moonwallet/frontend_test/src/utils/testUtils.ts"],"sourcesContent":["import { Connection, PublicKey, Transaction } from '@solana/web3.js';\nimport { Buffer } from 'buffer';\nimport { createSecp256r1Instruction } from './transactionUtils';\n\n// Định nghĩa kiểu wallet tương thích\ninterface WalletAdapter {\n  publicKey: PublicKey;\n  signTransaction: (transaction: Transaction) => Promise<Transaction>;\n}\n\n/**\n * Kiểm tra instruction secp256r1 độc lập\n * @param connection Kết nối Solana\n * @param message Message gốc cần xác thực\n * @param publicKey Public key đã nén (33 bytes)\n * @param signature Chữ ký raw (64 bytes)\n * @param wallet Wallet để ký giao dịch\n */\nexport async function testSecp256r1(\n  connection: Connection,\n  message: Buffer,\n  publicKey: Buffer,\n  signature: Buffer,\n  wallet: WalletAdapter\n): Promise<boolean> {\n  try {\n    console.log('Kiểm tra secp256r1 với:', {\n      publicKey: publicKey.toString('hex'),\n      publicKeyLength: publicKey.length,\n      signature: signature.toString('hex'),\n      signatureLength: signature.length,\n      message: message.toString(),\n      messageBytes: message.toString('hex'),\n      messageLength: message.length\n    });\n\n    // Tạo instruction secp256r1\n    const instruction = createSecp256r1Instruction(\n      message,\n      publicKey,\n      signature\n    );\n\n    // Tạo và gửi transaction\n    const transaction = new Transaction().add(instruction);\n    transaction.feePayer = wallet.publicKey;\n    const { blockhash } = await connection.getLatestBlockhash();\n    transaction.recentBlockhash = blockhash;\n\n    const signedTx = await wallet.signTransaction(transaction);\n    const txSignature = await connection.sendRawTransaction(signedTx.serialize());\n\n    console.log('Giao dịch đã được gửi với signature:', txSignature);\n    await connection.confirmTransaction(txSignature, 'confirmed');\n    console.log('Giao dịch đã được xác nhận');\n    \n    return true;\n  } catch (error) {\n    console.error('Lỗi khi kiểm tra secp256r1:', error);\n    return false;\n  }\n}\n\n/**\n * Tạo các biến thể khác nhau của public key để kiểm tra\n * @param publicKey Public key gốc\n */\nexport function generatePublicKeyVariants(publicKey: Buffer): Buffer[] {\n  const variants: Buffer[] = [];\n  \n  // Biến thể 1: Giữ nguyên public key gốc\n  variants.push(Buffer.from(publicKey));\n  console.log('Biến thể 1 (Gốc):', publicKey.toString('hex'));\n  \n  // Biến thể 2: Đảo ngược tất cả các byte\n  const fullReversedPubKey = Buffer.from(publicKey);\n  fullReversedPubKey.reverse();\n  variants.push(fullReversedPubKey);\n  console.log('Biến thể 2 (Đảo ngược tất cả):', fullReversedPubKey.toString('hex'));\n  \n  // Biến thể 3: Đảo ngược tất cả các byte trừ byte đầu tiên\n  const partialReversedPubKey = Buffer.alloc(33);\n  partialReversedPubKey[0] = publicKey[0]; // Giữ nguyên byte đầu tiên\n  for (let i = 1; i < 33; i++) {\n    partialReversedPubKey[i] = publicKey[34 - i]; // Đảo ngược các byte còn lại\n  }\n  variants.push(partialReversedPubKey);\n  console.log('Biến thể 3 (Đảo ngược trừ byte đầu):', partialReversedPubKey.toString('hex'));\n  \n  // Biến thể 4: Chuyển đổi byte đầu tiên giữa 0x02 và 0x03 (thay đổi dấu của y)\n  const prefixChangedPubKey = Buffer.from(publicKey);\n  if (prefixChangedPubKey[0] === 0x02) {\n    prefixChangedPubKey[0] = 0x03;\n  } else if (prefixChangedPubKey[0] === 0x03) {\n    prefixChangedPubKey[0] = 0x02;\n  }\n  variants.push(prefixChangedPubKey);\n  console.log('Biến thể 4 (Đổi dấu y):', prefixChangedPubKey.toString('hex'));\n\n  return variants;\n}\n\n/**\n * Kiểm tra với nhiều biến thể của public key\n */\nexport async function testMultiplePublicKeys(\n  connection: Connection,\n  message: Buffer,\n  signature: Buffer,\n  wallet: WalletAdapter,\n  publicKeyVariants: Buffer[]\n): Promise<void> {\n  console.log(`Bắt đầu kiểm tra với ${publicKeyVariants.length} biến thể của public key...`);\n  \n  for (let i = 0; i < publicKeyVariants.length; i++) {\n    const variant = publicKeyVariants[i];\n    console.log(`Kiểm tra biến thể #${i + 1}:`, variant.toString('hex'));\n    \n    const success = await testSecp256r1(\n      connection,\n      message,\n      variant,\n      signature,\n      wallet\n    );\n    \n    if (success) {\n      console.log(`Biến thể #${i + 1} thành công!`);\n    } else {\n      console.log(`Biến thể #${i + 1} thất bại.`);\n    }\n  }\n  \n  console.log('Đã hoàn tất việc kiểm tra các biến thể.');\n} "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}